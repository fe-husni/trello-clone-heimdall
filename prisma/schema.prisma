generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String         @id
  email              String?        @unique
  name               String?
  avatar             String?
  passwordHash       String?        @map("password_hash")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  activities         Activity[]
  uploads            Attachment[]   @relation("UserUploads")
  boardMembers       BoardMember[]
  cardsCreated       Card[]         @relation("CardCreatedBy")
  cardAssignees      CardAssignee[]
  comments           Comment[]
  memberships        Membership[]
  notifications      Notification[]
  ownedOrganizations Organization[] @relation("OrganizationOwner")
  sessions           Session[]

  @@index([email])
}

model Organization {
  id           String        @id @default(uuid())
  clerkOrgId   String        @unique @map("clerk_org_id")
  name         String
  ownerId      String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  boards       Board[]
  labels       Label[]
  memberships  Membership[]
  owner        User?         @relation("OrganizationOwner", fields: [ownerId], references: [id])
  subscription Subscription?

  @@index([name])
  @@index([clerkOrgId])
  @@index([ownerId], map: "Organization_ownerId_fkey")
}

model Membership {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  role           String       @default("member")
  createdAt      DateTime     @default(now()) @map("created_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

model Board {
  id             String        @id @default(uuid())
  title          String
  description    String?
  coverImage     String?       @map("cover_image")
  organizationId String
  isPrivate      Boolean       @default(false) @map("is_private")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  boardMembers   BoardMember[]
  lists          List[]

  @@index([organizationId])
}

model BoardMember {
  id        String   @id @default(uuid())
  boardId   String
  userId    String
  role      String   @default("member")
  createdAt DateTime @default(now()) @map("created_at")
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@index([boardId])
  @@index([userId])
}

model List {
  id        String   @id @default(uuid())
  title     String
  position  Float    @default(0)
  boardId   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  cards     Card[]
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId, position])
}

model Card {
  id          String         @id @default(uuid())
  title       String
  description String?
  position    Float          @default(0)
  dueDate     DateTime?      @map("due_date")
  listId      String
  createdById String?
  archived    Boolean        @default(false)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  activities  Activity[]
  attachments Attachment[]
  createdBy   User?          @relation("CardCreatedBy", fields: [createdById], references: [id])
  list        List           @relation(fields: [listId], references: [id], onDelete: Cascade)
  assignees   CardAssignee[]
  labels      CardLabel[]
  comments    Comment[]

  @@index([listId, position])
  @@index([createdById])
}

model CardAssignee {
  id         String   @id @default(uuid())
  cardId     String
  userId     String
  assignedAt DateTime @default(now()) @map("assigned_at")
  card       Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cardId, userId])
  @@index([cardId])
  @@index([userId])
}

model Label {
  id             String        @id @default(uuid())
  name           String?
  color          String?
  organizationId String?
  createdAt      DateTime      @default(now()) @map("created_at")
  cardLabels     CardLabel[]
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model CardLabel {
  id      String @id @default(uuid())
  cardId  String
  labelId String
  card    Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)
  label   Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([cardId, labelId])
  @@index([cardId])
  @@index([labelId])
}

model Attachment {
  id         String   @id @default(uuid())
  cardId     String
  filename   String?
  url        String?
  mimeType   String?  @map("mime_type")
  size       Int?
  uploadedBy String?  @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")
  card       Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  uploader   User?    @relation("UserUploads", fields: [uploadedBy], references: [id])

  @@index([cardId])
  @@index([uploadedBy], map: "Attachment_uploaded_by_fkey")
}

model Activity {
  id        String   @id @default(uuid())
  cardId    String?
  userId    String?
  action    String
  meta      String?  @db.LongText
  createdAt DateTime @default(now()) @map("created_at")
  card      Card?    @relation(fields: [cardId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([cardId])
  @@index([userId])
}

model Comment {
  id        String   @id @default(uuid())
  cardId    String
  authorId  String
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([authorId])
}

model Subscription {
  id                   String       @id @default(uuid())
  organizationId       String       @unique
  stripeCustomerId     String?      @map("stripe_customer_id")
  stripeSubscriptionId String?      @map("stripe_subscription_id")
  plan                 String?
  active               Boolean      @default(false)
  startedAt            DateTime?    @map("started_at")
  endedAt              DateTime?    @map("ended_at")
  createdAt            DateTime     @default(now()) @map("created_at")
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Notification {
  id          String    @id @default(uuid())
  userId      String
  type        String
  payload     String?   @db.LongText
  read        Boolean   @default(false)
  createdAt   DateTime  @default(now()) @map("created_at")
  deliveredAt DateTime? @map("delivered_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Session {
  id        String    @id @default(uuid())
  userId    String
  token     String
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
